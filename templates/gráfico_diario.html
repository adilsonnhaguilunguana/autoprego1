<!-- gr√°fico_diario.html -->
<div class="dias-chart-container">
    <div class="chart-header">
        <h5><i class="bi bi-lightning-charge"></i> Consumo Di√°rio de Pot√™ncia</h5>
        <div class="period-controls">
            <button class="btn-periodo active" data-period="week">
                <i class="bi bi-calendar-week"></i> Semana
            </button>
            <button class="btn-periodo" data-period="month">
                <i class="bi bi-calendar-month"></i> M√™s
            </button>
            <button class="btn-periodo" data-period="custom">
                <i class="bi bi-calendar-range"></i> Personalizado
            </button>
        </div>
    </div>
    
    <div class="chart-wrapper">
        <div class="chart-canvas-container">
            <canvas id="diasChart"></canvas>
        </div>
        <div class="chart-loading-overlay">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    </div>
</div>

<style>
/* ===== ESTILOS DO GR√ÅFICO DI√ÅRIO ===== */
.dias-chart-container {
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color, #dee2e6);
    transition: all 0.3s ease;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* Cabe√ßalho do gr√°fico */
.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
    flex-shrink: 0;
}

.chart-header h5 {
    font-weight: 700;
    color: var(--text-primary, #212529);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.chart-header h5 i {
    color: var(--primary, #1a73e8);
}

/* Controles de per√≠odo */
.period-controls {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-periodo {
    padding: 0.5rem 1rem;
    border: 2px solid var(--primary, #1a73e8);
    background: transparent;
    color: var(--primary, #1a73e8);
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    flex-shrink: 0;
}

.btn-periodo:hover {
    background: var(--primary, #1a73e8);
    color: white;
    transform: translateY(-1px);
}

.btn-periodo.active {
    background: var(--primary, #1a73e8);
    color: white;
    box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
}

/* Container principal do gr√°fico */
.chart-wrapper {
    position: relative;
    flex: 1;
    min-height: 0; /* IMPORTANTE: Permite que o gr√°fico encolha */
    width: 100%;
    display: flex;
}

/* Container do canvas - ESSENCIAL para responsividade */
.chart-canvas-container {
    position: relative;
    flex: 1;
    width: 100%;
    height: 100%;
}

#diasChart {
    display: block;
    width: 100% !important;
    height: 100% !important;
    max-width: 100%;
    max-height: 100%;
}

/* Loading overlay */
.chart-loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10;
    border-radius: 12px;
}

.chart-loading-overlay.active {
    display: flex;
}

.chart-loading-overlay .spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 3px;
}

/* Tooltip personalizado */
.chartjs-tooltip-dias {
    background: rgba(0, 0, 0, 0.9) !important;
    border-radius: 10px !important;
    border: 2px solid var(--primary, #1a73e8) !important;
    padding: 12px 16px !important;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3) !important;
    backdrop-filter: blur(10px);
}

.chartjs-tooltip-dias .tooltip-header {
    color: #fff !important;
    font-weight: 700 !important;
    margin-bottom: 8px !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
    padding-bottom: 6px !important;
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
}

.chartjs-tooltip-dias .tooltip-body {
    color: #fff !important;
    font-size: 0.875rem !important;
}

.chartjs-tooltip-dias .tooltip-item {
    display: flex !important;
    align-items: center !important;
    gap: 6px !important;
    margin: 4px 0 !important;
}

/* ===== AJUSTES ESPEC√çFICOS PARA O SEU LAYOUT ===== */
/* Seu container pai */
.chart-container {
    width: 100%;
    height: 100%;
    min-height: 400px; /* Altura m√≠nima */
}

/* Garantir que o gr√°fico use 100% do espa√ßo dispon√≠vel */
.chart-container .dias-chart-container {
    height: 100%;
}

/* Responsividade */
@media (max-width: 768px) {
    .dias-chart-container {
        padding: 1rem;
    }
    
    .chart-header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .period-controls {
        width: 100%;
        justify-content: center;
    }
    
    .btn-periodo {
        padding: 0.4rem 0.75rem;
        font-size: 0.8rem;
    }
    
    /* Ajuste de altura em mobile */
    .chart-container {
        min-height: 350px;
    }
}

@media (max-width: 480px) {
    .dias-chart-container {
        padding: 0.75rem;
    }
    
    .chart-container {
        min-height: 300px;
    }
}

/* Dark mode support */
[data-bs-theme="dark"] .dias-chart-container {
    background: var(--bg-secondary, #1e1e1e);
    border-color: var(--border-color, #444);
}

[data-bs-theme="dark"] .chart-loading-overlay {
    background: rgba(30, 30, 30, 0.9);
}

[data-bs-theme="dark"] .chartjs-tooltip-dias {
    background: rgba(40, 40, 40, 0.95) !important;
    border-color: var(--primary, #1a73e8) !important;
}

/* Classes utilit√°rias para garantir o tamanho */
.full-height {
    height: 100%;
}

.full-width {
    width: 100%;
}

.flex-grow {
    flex-grow: 1;
}

.flex-shrink {
    flex-shrink: 1;
}
</style>

<script>
// gr√°fico_diario.js - Com ajustes de redimensionamento
(function() {
    'use strict';
    
    const GraficoDiario = {
        config: {
            apiEndpoint: '/api/grafico-diario',
            chartId: 'diasChart',
            colors: {
                primary: '#1a73e8',
                primaryLight: 'rgba(26, 115, 232, 0.1)'
            },
            defaultPeriod: 'week'
        },
        
        state: {
            chart: null,
            dados: null,
            periodo: 'week',
            loading: false,
            resizeObserver: null
        },
        
        init: function() {
            console.log('üìà Inicializando gr√°fico di√°rio...');
            
            if (!this._checkRequirements()) {
                return false;
            }
            
            this._setupChart();
            this._setupControls();
            this._setupEventListeners();
            
            // Iniciar observador de redimensionamento
            this._setupResizeObserver();
            
            setTimeout(() => {
                this.carregarDados(this.config.defaultPeriod);
            }, 500);
            
            console.log('‚úÖ Gr√°fico di√°rio inicializado');
            return true;
        },
        
        _checkRequirements: function() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js n√£o carregado');
                return false;
            }
            
            if (!document.getElementById(this.config.chartId)) {
                console.error(`Canvas #${this.config.chartId} n√£o encontrado`);
                return false;
            }
            
            return true;
        },
        
        _setupChart: function() {
            const canvas = document.getElementById(this.config.chartId);
            const ctx = canvas.getContext('2d');
            
            // Configurar tamanho inicial
            this._updateCanvasSize(canvas);
            
            this.state.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Pot√™ncia (W)',
                        data: [],
                        borderColor: this.config.colors.primary,
                        backgroundColor: this.config.colors.primaryLight,
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointHoverRadius: 8,
                        pointBackgroundColor: this.config.colors.primary,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: this._getChartOptions()
            });
            
            this._setupCustomTooltip();
        },
        
        _getChartOptions: function() {
            return {
                responsive: true,
                maintainAspectRatio: false, // IMPORTANTE: desativa propor√ß√£o fixa
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: this._getThemeColor('text-primary'),
                            font: {
                                size: 14,
                                weight: '600'
                            },
                            padding: 20
                        }
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'transparent',
                        titleColor: 'transparent',
                        bodyColor: 'transparent',
                        borderColor: 'transparent',
                        borderWidth: 0,
                        padding: 0,
                        external: this._customTooltip.bind(this)
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Pot√™ncia (W)',
                            color: this._getThemeColor('text-primary'),
                            font: {
                                size: 14,
                                weight: '600'
                            }
                        },
                        grid: {
                            color: this._getThemeColor('grid', 'rgba(0, 0, 0, 0.1)'),
                            drawBorder: false
                        },
                        ticks: {
                            color: this._getThemeColor('text-secondary'),
                            font: {
                                size: 12
                            },
                            padding: 10,
                            callback: function(value) {
                                return value + ' W';
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: this._getThemeColor('grid', 'rgba(0, 0, 0, 0.1)'),
                            drawBorder: false
                        },
                        ticks: {
                            color: this._getThemeColor('text-secondary'),
                            font: {
                                size: 12
                            },
                            maxRotation: 45,
                            padding: 5
                        },
                        title: {
                            display: true,
                            text: 'Data',
                            color: this._getThemeColor('text-primary'),
                            font: {
                                size: 14,
                                weight: '600'
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'nearest'
                },
                animations: {
                    tension: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                },
                // Configura√ß√£o para melhor redimensionamento
                layout: {
                    padding: {
                        left: 10,
                        right: 10,
                        top: 10,
                        bottom: 10
                    }
                }
            };
        },
        
        _getThemeColor: function(type, fallback) {
            const root = document.documentElement;
            const theme = root.getAttribute('data-bs-theme') || 'light';
            
            const colors = {
                light: {
                    'text-primary': '#212529',
                    'text-secondary': '#6c757d',
                    'grid': 'rgba(0, 0, 0, 0.1)'
                },
                dark: {
                    'text-primary': '#e0e0e0',
                    'text-secondary': '#a0a0a0',
                    'grid': 'rgba(255, 255, 255, 0.1)'
                }
            };
            
            return colors[theme]?.[type] || fallback || '#000000';
        },
        
        _setupCustomTooltip: function() {
            let tooltipEl = document.getElementById('diasChart-tooltip');
            
            if (!tooltipEl) {
                tooltipEl = document.createElement('div');
                tooltipEl.id = 'diasChart-tooltip';
                tooltipEl.className = 'chartjs-tooltip-dias';
                tooltipEl.style.cssText = `
                    position: absolute;
                    pointer-events: none;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    z-index: 1000;
                `;
                document.body.appendChild(tooltipEl);
            }
        },
        
        _customTooltip: function(context) {
            const tooltipEl = document.getElementById('diasChart-tooltip');
            
            let tooltipModel = context.tooltip;
            if (tooltipModel.opacity === 0) {
                tooltipEl.style.opacity = 0;
                return;
            }
            
            if (tooltipModel.body) {
                const title = tooltipModel.title[0];
                const dataIndex = tooltipModel.dataPoints[0].dataIndex;
                
                let tooltipHTML = `
                    <div class="tooltip-header">
                        <i class="bi bi-calendar"></i> ${title}
                    </div>
                    <div class="tooltip-body">
                `;
                
                if (this.state.dados) {
                    const dados = this.state.dados;
                    tooltipHTML += `
                        <div class="tooltip-item">
                            <i class="bi bi-lightning" style="color: #1a73e8;"></i>
                            <span>Pot√™ncia: <strong>${dados.potencia[dataIndex]?.toFixed(1) || 0} W</strong></span>
                        </div>
                        <div class="tooltip-item">
                            <i class="bi bi-lightning-charge" style="color: #28a745;"></i>
                            <span>Tens√£o: <strong>${dados.tensao[dataIndex]?.toFixed(1) || 0} V</strong></span>
                        </div>
                        <div class="tooltip-item">
                            <i class="bi bi-arrow-right-circle" style="color: #17a2b8;"></i>
                            <span>Corrente: <strong>${dados.corrente[dataIndex]?.toFixed(2) || 0} A</strong></span>
                        </div>
                        <div class="tooltip-item">
                            <i class="bi bi-battery-charging" style="color: #ffc107;"></i>
                            <span>Energia: <strong>${dados.energia[dataIndex]?.toFixed(2) || 0} kWh</strong></span>
                        </div>
                    `;
                } else {
                    const value = tooltipModel.dataPoints[0].parsed.y;
                    tooltipHTML += `
                        <div class="tooltip-item">
                            <i class="bi bi-lightning"></i>
                            <span>Pot√™ncia: <strong>${value.toFixed(1)} W</strong></span>
                        </div>
                    `;
                }
                
                tooltipHTML += '</div>';
                tooltipEl.innerHTML = tooltipHTML;
                
                const position = context.chart.canvas.getBoundingClientRect();
                tooltipEl.style.opacity = 1;
                tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
                tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
                tooltipEl.style.transform = 'translate(-50%, -100%) translateY(-10px)';
            }
        },
        
        _setupControls: function() {
            const botoes = document.querySelectorAll('.btn-periodo');
            
            botoes.forEach(botao => {
                botao.addEventListener('click', (e) => this._onPeriodoClick(e));
            });
            
            const activeBtn = document.querySelector(`.btn-periodo[data-period="${this.config.defaultPeriod}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        },
        
        _setupEventListeners: function() {
            // Redimensionar janela
            window.addEventListener('resize', () => {
                this._handleResize();
            });
            
            // Observar mudan√ßas de tema
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.attributeName === 'data-bs-theme' && this.state.chart) {
                        setTimeout(() => this.state.chart.update(), 100);
                    }
                });
            });
            
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['data-bs-theme']
            });
        },
        
        _setupResizeObserver: function() {
            // Observar mudan√ßas no container pai
            const container = document.querySelector('.chart-canvas-container');
            if (!container || !window.ResizeObserver) return;
            
            this.state.resizeObserver = new ResizeObserver((entries) => {
                for (let entry of entries) {
                    this._handleResize();
                }
            });
            
            this.state.resizeObserver.observe(container);
        },
        
        _handleResize: function() {
            if (!this.state.chart) return;
            
            const canvas = document.getElementById(this.config.chartId);
            if (!canvas) return;
            
            // Atualizar tamanho do canvas
            this._updateCanvasSize(canvas);
            
            // Redesenhar gr√°fico
            setTimeout(() => {
                this.state.chart.resize();
                this.state.chart.update();
            }, 100);
        },
        
        _updateCanvasSize: function(canvas) {
            const container = canvas.closest('.chart-canvas-container');
            if (!container) return;
            
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // Atualizar atributos de tamanho
            canvas.style.width = containerWidth + 'px';
            canvas.style.height = containerHeight + 'px';
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            
            console.log(`üìè Canvas atualizado: ${containerWidth}x${containerHeight}px`);
        },
        
        _onPeriodoClick: function(event) {
            const botao = event.currentTarget;
            const periodo = botao.dataset.period;
            
            document.querySelectorAll('.btn-periodo').forEach(b => {
                b.classList.remove('active');
            });
            botao.classList.add('active');
            
            if (periodo === 'custom') {
                this._abrirSeletorDatas();
            } else {
                this.carregarDados(periodo);
            }
        },
        
        _abrirSeletorDatas: function() {
            if (typeof Swal !== 'undefined') {
                const hoje = new Date();
                const umaSemanaAtras = new Date(hoje.getTime() - 7 * 24 * 60 * 60 * 1000);
                
                Swal.fire({
                    title: 'Selecionar Per√≠odo',
                    html: `
                        <div class="mb-3">
                            <label class="form-label">Data Inicial</label>
                            <input type="date" id="start-date" class="form-control" 
                                   value="${umaSemanaAtras.toISOString().split('T')[0]}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data Final</label>
                            <input type="date" id="end-date" class="form-control" 
                                   value="${hoje.toISOString().split('T')[0]}">
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Carregar',
                    cancelButtonText: 'Cancelar',
                    preConfirm: () => {
                        const start = document.getElementById('start-date').value;
                        const end = document.getElementById('end-date').value;
                        
                        if (!start || !end) {
                            Swal.showValidationMessage('Preencha ambas as datas');
                            return false;
                        }
                        
                        if (new Date(start) > new Date(end)) {
                            Swal.showValidationMessage('Data inicial deve ser anterior √† final');
                            return false;
                        }
                        
                        return { start, end };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.carregarDados(`custom?start=${result.value.start}&end=${result.value.end}`);
                    }
                });
            } else {
                const start = prompt('Data inicial (YYYY-MM-DD):', 
                    new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]);
                const end = prompt('Data final (YYYY-MM-DD):', 
                    new Date().toISOString().split('T')[0]);
                
                if (start && end) {
                    this.carregarDados(`custom?start=${start}&end=${end}`);
                }
            }
        },
        
        carregarDados: async function(periodo = null) {
            if (periodo) {
                this.state.periodo = periodo;
            }
            
            try {
                this._setLoading(true);
                
                const url = this._buildApiUrl();
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Erro na API');
                }
                
                this._processarResposta(data);
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                this._usarDadosDemonstracao();
            } finally {
                this._setLoading(false);
            }
        },
        
        _buildApiUrl: function() {
            let url = this.config.apiEndpoint;
            
            if (this.state.periodo.includes('custom?')) {
                url += this.state.periodo.replace('custom?', '?period=custom&');
            } else {
                url += `?period=${this.state.periodo}`;
            }
            
            return url;
        },
        
        _processarResposta: function(data) {
            this.state.dados = {
                datas: data.datas || [],
                potencia: data.potencia || [],
                tensao: data.tensao || [],
                corrente: data.corrente || [],
                energia: data.energia || []
            };
            
            this._atualizarGrafico();
        },
        
        _atualizarGrafico: function() {
            if (!this.state.chart || !this.state.dados) return;
            
            const dados = this.state.dados;
            
            this.state.chart.data.labels = dados.datas;
            this.state.chart.data.datasets[0].data = dados.potencia;
            
            if (dados.potencia.length > 0) {
                const soma = dados.potencia.reduce((a, b) => a + b, 0);
                const media = soma / dados.potencia.length;
                this.state.chart.data.datasets[0].label = `Pot√™ncia (M√©dia: ${media.toFixed(1)} W)`;
            }
            
            this.state.chart.update();
        },
        
        _usarDadosDemonstracao: function() {
            const datas = [];
            const potencia = [];
            const tensao = [];
            const corrente = [];
            const energia = [];
            
            const hoje = new Date();
            let energiaAcumulada = 15.5;
            
            for (let i = 6; i >= 0; i--) {
                const data = new Date(hoje);
                data.setDate(hoje.getDate() - i);
                
                datas.push(data.toLocaleDateString('pt-BR', { 
                    day: 'numeric', 
                    month: 'short' 
                }));
                
                const pwr = Math.random() * 1800 + 700;
                potencia.push(Math.round(pwr * 10) / 10);
                tensao.push(+(Math.random() * 8 + 218).toFixed(1));
                corrente.push(+(pwr / 220 + Math.random() * 2).toFixed(2));
                
                energiaAcumulada += pwr * 24 / 1000;
                energia.push(+(energiaAcumulada).toFixed(1));
            }
            
            const mockData = {
                success: true,
                datas: datas,
                potencia: potencia,
                tensao: tensao,
                corrente: corrente,
                energia: energia,
                total_dias: datas.length
            };
            
            this._processarResposta(mockData);
        },
        
        _setLoading: function(loading) {
            this.state.loading = loading;
            
            const overlay = document.querySelector('.chart-loading-overlay');
            if (overlay) {
                overlay.classList.toggle('active', loading);
            }
        },
        
        recarregar: function() {
            this.carregarDados();
        },
        
        setPeriodo: function(periodo) {
            this.state.periodo = periodo;
            this.carregarDados();
        },
        
        destroy: function() {
            if (this.state.chart) {
                this.state.chart.destroy();
                this.state.chart = null;
            }
            
            if (this.state.resizeObserver) {
                this.state.resizeObserver.disconnect();
            }
            
            const tooltipEl = document.getElementById('diasChart-tooltip');
            if (tooltipEl) {
                tooltipEl.remove();
            }
        }
    };
    
    // Inicializar quando o container estiver vis√≠vel
    const initChart = () => {
        const container = document.querySelector('.chart-container');
        if (container && container.offsetParent !== null) {
            setTimeout(() => GraficoDiario.init(), 100);
        } else {
            // Esperar um pouco e tentar novamente
            setTimeout(initChart, 500);
        }
    };
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChart);
    } else {
        initChart();
    }
    
    window.GraficoDiario = GraficoDiario;
    
    console.log('üìä Gr√°fico di√°rio carregado (com ajuste de tamanho)');
})();
</script>